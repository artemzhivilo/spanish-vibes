{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<section class="grid gap-8">
  <div class="rounded-2xl bg-[#1a2d35] p-6 shadow-lg shadow-black/20">
    <h2 class="text-2xl font-bold text-slate-50">Lessons</h2>
    <p class="mt-1 text-sm text-slate-400">Browse all chapters and jump straight into practice.</p>
    <div class="mt-5 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <div class="rounded-xl bg-[#0f1a1f] p-4 text-center ring-1 ring-fuchsia-500/20">
        <p class="text-[10px] uppercase tracking-widest font-bold text-fuchsia-400">Chapters</p>
        <p class="mt-2 text-3xl font-black text-slate-50">{{ totals.chapters }}</p>
      </div>
      <div class="rounded-xl bg-[#0f1a1f] p-4 text-center ring-1 ring-sky-500/20">
        <p class="text-[10px] uppercase tracking-widest font-bold text-sky-400">Lessons</p>
        <p class="mt-2 text-3xl font-black text-slate-50">{{ totals.lessons }}</p>
      </div>
      <div class="rounded-xl bg-[#0f1a1f] p-4 text-center ring-1 ring-amber-500/20">
        <p class="text-[10px] uppercase tracking-widest font-bold text-amber-400">Cards</p>
        <p class="mt-2 text-3xl font-black text-slate-50">{{ totals.cards }}</p>
      </div>
      <div class="rounded-xl bg-[#0f1a1f] p-4 text-center ring-1 ring-emerald-500/20">
        <p class="text-[10px] uppercase tracking-widest font-bold text-emerald-400">Due Now</p>
        <p class="mt-2 text-3xl font-black text-emerald-400">{{ totals.due }}</p>
      </div>
    </div>
  </div>

  {% for chapter_num, lessons in chapters.items() %}
    <div class="grid gap-5">
      <h3 class="flex items-center gap-3 text-xl font-bold text-slate-50">
        <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-emerald-500 text-sm font-black text-emerald-950 shadow shadow-emerald-500/30">{{ chapter_num }}</span>
        Chapter {{ chapter_num }}
        <span class="text-sm font-normal text-slate-500">({{ lessons|length }} lesson{{ 's' if lessons|length != 1 else '' }})</span>
      </h3>

      {% for lesson in lessons %}
        <article class="rounded-2xl bg-[#1a2d35] shadow-lg shadow-black/20 transition hover:shadow-xl hover:-translate-y-0.5">
          <header class="flex flex-col gap-3 px-6 py-5 sm:flex-row sm:items-center sm:justify-between">
            <div class="min-w-0 flex-1">
              <div class="flex items-center gap-2">
                <span class="shrink-0 text-sm font-black text-emerald-400">{{ lesson.slug|chapter_label }}</span>
                <h4 class="truncate text-lg font-bold text-slate-50">
                  <a href="/lesson/{{ lesson.slug }}" class="hover:text-emerald-300 transition">{{ lesson.title }}</a>
                </h4>
              </div>
              <div class="mt-2 flex flex-wrap items-center gap-2">
                {% set diff = lesson.difficulty %}
                {% if 'Beginner' in diff %}
                  <span class="rounded-full bg-emerald-500/15 px-3 py-1 text-xs font-bold text-emerald-300">{{ diff }}</span>
                {% elif 'Intermediate' in diff and 'Upper' not in diff %}
                  <span class="rounded-full bg-sky-500/15 px-3 py-1 text-xs font-bold text-sky-300">{{ diff }}</span>
                {% else %}
                  <span class="rounded-full bg-fuchsia-500/15 px-3 py-1 text-xs font-bold text-fuchsia-300">{{ diff }}</span>
                {% endif %}
                <span class="text-xs text-slate-500 font-medium">Level {{ lesson.level_score }}</span>
              </div>
            </div>
            <div class="flex shrink-0 items-center gap-6 text-sm">
              <div class="text-center">
                <p class="text-2xl font-black text-slate-50">{{ lesson.total_cards }}</p>
                <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">cards</p>
              </div>
              <div class="text-center">
                <p class="text-2xl font-black text-emerald-400">{{ lesson.due_cards }}</p>
                <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">due</p>
              </div>
            </div>
          </header>

          {% if lesson.total_cards > 0 %}
            {% set m = mastery.get(lesson.id, {}) if mastery is defined else {} %}
            <div class="px-6 pb-3">
              <div class="flex items-center gap-3 mb-2">
                {% set tier = m.get('tier', 'none') if m else 'none' %}
                {% if tier == 'gold' %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-amber-500/20 px-3 py-1 text-sm font-black text-amber-400 ring-1 ring-amber-500/30">
                    <span class="text-base">‚≠ê</span> Gold
                  </span>
                {% elif tier == 'silver' %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-slate-400/15 px-3 py-1 text-sm font-black text-slate-300 ring-1 ring-slate-400/30">
                    <span class="text-base">ü•à</span> Silver
                  </span>
                {% elif tier == 'bronze' %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-orange-500/15 px-3 py-1 text-sm font-black text-orange-400 ring-1 ring-orange-500/30">
                    <span class="text-base">ü•â</span> Bronze
                  </span>
                {% else %}
                  <span class="rounded-full bg-slate-500/15 px-3 py-1 text-xs font-bold text-slate-400 uppercase tracking-wide">New</span>
                {% endif %}
                {% if m %}
                  <span class="text-sm text-slate-400 font-medium">{{ m.get('mastered', 0) }}/{{ m.get('total', lesson.total_cards) }} mastered</span>
                {% endif %}
              </div>
              {% if m and m.get('total', 0) > 0 %}
                {% set total = m['total'] %}
                {% set mastered_pct = (m.get('mastered', 0) / total * 100)|round(1) %}
                {% set familiar_pct = (m.get('familiar', 0) / total * 100)|round(1) %}
                {% set learning_pct = (m.get('learning', 0) / total * 100)|round(1) %}
                <div class="h-3 w-full overflow-hidden rounded-full bg-[#0f1a1f] flex">
                  {% if mastered_pct > 0 %}
                    <div class="h-full bg-amber-500 transition-all duration-500" style="width: {{ mastered_pct }}%"></div>
                  {% endif %}
                  {% if familiar_pct > 0 %}
                    <div class="h-full bg-emerald-500 transition-all duration-500" style="width: {{ familiar_pct }}%"></div>
                  {% endif %}
                  {% if learning_pct > 0 %}
                    <div class="h-full bg-sky-500 transition-all duration-500" style="width: {{ learning_pct }}%"></div>
                  {% endif %}
                </div>
                <div class="mt-2 flex gap-4 text-xs text-slate-500 font-medium">
                  <span class="flex items-center gap-1.5"><span class="inline-block h-2.5 w-2.5 rounded-full bg-amber-500"></span>Mastered</span>
                  <span class="flex items-center gap-1.5"><span class="inline-block h-2.5 w-2.5 rounded-full bg-emerald-500"></span>Familiar</span>
                  <span class="flex items-center gap-1.5"><span class="inline-block h-2.5 w-2.5 rounded-full bg-sky-500"></span>Learning</span>
                </div>
              {% else %}
                <div class="h-3 w-full overflow-hidden rounded-full bg-[#0f1a1f]">
                  {% set pct = ((lesson.total_cards - lesson.due_cards) / lesson.total_cards * 100)|int %}
                  <div class="h-full rounded-full bg-emerald-500/70 transition-all duration-500" style="width: {{ pct }}%"></div>
                </div>
              {% endif %}
            </div>
          {% endif %}

          <div class="divide-y divide-[#0f1a1f] border-t border-[#0f1a1f]">
            {% for deck in lesson.decks %}
              <div class="flex flex-col gap-2 px-6 py-3 sm:flex-row sm:items-center sm:justify-between">
                <div class="flex items-center gap-3">
                  {% if deck.kind == 'vocab' %}
                    <span class="inline-flex h-7 w-7 items-center justify-center rounded-lg bg-emerald-500/15 text-xs font-black text-emerald-400">V</span>
                  {% elif deck.kind == 'fillblank' %}
                    <span class="inline-flex h-7 w-7 items-center justify-center rounded-lg bg-sky-500/15 text-xs font-black text-sky-400">F</span>
                  {% else %}
                    <span class="inline-flex h-7 w-7 items-center justify-center rounded-lg bg-fuchsia-500/15 text-xs font-black text-fuchsia-400">C</span>
                  {% endif %}
                  <span class="text-sm text-slate-200 font-medium">{{ deck.kind|replace('_', ' ')|title }}</span>
                </div>
                <div class="flex items-center gap-4 text-sm">
                  <span class="text-slate-400"><strong class="text-slate-200 font-bold">{{ deck.card_count }}</strong> cards</span>
                  <span class="text-slate-400"><strong class="text-emerald-400 font-bold">{{ deck.due_count }}</strong> due</span>
                  <button
                    hx-get="/quiz?lesson={{ lesson.slug }}&kind={{ deck.kind }}"
                    hx-target="#practice-{{ lesson.slug }}-{{ deck.kind }}"
                    hx-swap="innerHTML"
                    class="rounded-full bg-emerald-500 px-4 py-1.5 text-xs font-black text-emerald-950 shadow shadow-emerald-500/20 transition hover:bg-emerald-400 hover:scale-[1.02] active:scale-[0.98]">
                    Practice
                  </button>
                  <a href="/practice?lesson={{ lesson.slug }}&kind={{ deck.kind }}"
                     class="rounded-full bg-[#0f1a1f] px-3 py-1.5 text-xs font-bold text-slate-400 transition hover:text-slate-200 hover:bg-[#162028]"
                     title="Open full practice page">
                    <svg class="inline h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                  </a>
                </div>
              </div>
            {% endfor %}
          </div>
          <!-- Inline practice panel -->
          {% for deck in lesson.decks %}
            <div id="practice-{{ lesson.slug }}-{{ deck.kind }}" class="practice-slot"></div>
          {% endfor %}
        </article>
      {% endfor %}
    </div>
  {% endfor %}
</section>
{% endblock %}
