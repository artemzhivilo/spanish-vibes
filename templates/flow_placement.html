{% extends "base.html" %}
{% block title %}Spanish Vibes Â· Placement{% endblock %}
{% block content %}
<div id="flow-container" class="flex flex-col items-center gap-6 max-w-2xl mx-auto">
  <div class="w-full text-center mb-2">
    <h2 class="text-xl font-black text-slate-100">Placement Conversation</h2>
    <p class="text-sm text-slate-400 mt-1">Chat in Spanish so we can find your level.</p>
  </div>

  <div id="flow-card-slot" class="w-full">
    {% include "partials/flow_conversation.html" %}
  </div>
</div>

<!-- Speech utilities (needed for conversation TTS/STT) -->
<script>
window.speakSpanish = function(text, rate) {
  if (!window.speechSynthesis) return;
  speechSynthesis.cancel();
  var utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'es-ES';
  utterance.rate = rate || 0.85;
  var voices = speechSynthesis.getVoices();
  var spanishVoice = voices.find(function(v) { return v.lang && v.lang.startsWith('es'); });
  if (spanishVoice) utterance.voice = spanishVoice;
  speechSynthesis.speak(utterance);
};

window.startSpanishListening = function(inputSelector, statusSelector, micBtnSelector) {
  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert('Speech recognition is not supported in this browser.');
    return;
  }
  var recognition = new SpeechRecognition();
  recognition.lang = 'es-ES';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  var input = document.querySelector(inputSelector);
  var status = document.querySelector(statusSelector);
  var micBtn = document.querySelector(micBtnSelector);
  if (status) { status.textContent = 'Listening...'; status.classList.remove('hidden'); }
  if (micBtn) { micBtn.classList.add('text-red-400'); }
  recognition.start();
  recognition.onresult = function(event) {
    var transcript = event.results[0][0].transcript;
    if (input) { input.value = transcript; input.focus(); }
    if (status) { status.textContent = 'Got it!'; setTimeout(function() { status.classList.add('hidden'); }, 1500); }
    if (micBtn) { micBtn.classList.remove('text-red-400'); }
  };
  recognition.onerror = function() {
    if (status) { status.textContent = 'Could not hear you. Try again.'; setTimeout(function() { status.classList.add('hidden'); }, 2000); }
    if (micBtn) { micBtn.classList.remove('text-red-400'); }
  };
  recognition.onend = function() {
    if (micBtn) { micBtn.classList.remove('text-red-400'); }
  };
};

// Hide mic if not supported
(function() {
  var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    var btn = document.getElementById('conv-mic-btn');
    if (btn) btn.style.display = 'none';
  }
})();
</script>
{% endblock %}
