<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Spanish Vibes{% endblock %}</title>
    <!-- CDN Tailwind is fine for dev; swap to a compiled build before production. -->
    <script src="https://cdn.tailwindcss.com" defer></script>
    <script src="https://unpkg.com/htmx.org@1.9.12/dist/htmx.min.js" crossorigin="anonymous" defer></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        if (!window.htmx) {
          console.error("HTMX failed to load. Check your network/extension settings or bundle htmx locally.");
        }
      });
    </script>
    <style>
      /* Custom scrollbar for dark theme */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #0f1a1f; }
      ::-webkit-scrollbar-thumb { background: #2a3f4a; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #3a5565; }

      /* Lesson prose styling */
      .lesson-prose { color: #cbd5e1; line-height: 1.8; }
      .lesson-prose h1 {
        font-size: 1.75rem; font-weight: 800; color: #f8fafc;
        margin: 2.5rem 0 1rem; padding-bottom: 0.5rem;
        border-bottom: 2px solid #1e3a47;
      }
      .lesson-prose h2 {
        font-size: 1.35rem; font-weight: 700; color: #6ee7b7;
        margin: 2rem 0 0.75rem;
        display: flex; align-items: center; gap: 0.5rem;
      }
      .lesson-prose h2::before {
        content: ''; display: inline-block; width: 4px; height: 1.2em;
        background: #34d399; border-radius: 2px; flex-shrink: 0;
      }
      .lesson-prose h3 {
        font-size: 1.1rem; font-weight: 700; color: #93c5fd;
        margin: 1.5rem 0 0.5rem;
      }
      .lesson-prose p { margin: 0.75rem 0; }
      .lesson-prose ul, .lesson-prose ol { margin: 0.75rem 0; padding-left: 0; list-style: none; }
      .lesson-prose ul > li, .lesson-prose ol > li {
        position: relative; padding: 0.5rem 0.75rem 0.5rem 1.75rem;
        margin: 0.35rem 0; background: #0f1a1f; border-radius: 0.75rem;
      }
      .lesson-prose ul > li::before {
        content: ''; position: absolute; left: 0.75rem; top: 0.95rem;
        width: 6px; height: 6px; border-radius: 50%; background: #34d399;
      }
      .lesson-prose ol { counter-reset: lesson-counter; }
      .lesson-prose ol > li { counter-increment: lesson-counter; }
      .lesson-prose ol > li::before {
        content: counter(lesson-counter); position: absolute; left: 0.55rem; top: 0.45rem;
        width: 1.25rem; height: 1.25rem; border-radius: 50%;
        background: #34d399; color: #022c22; font-size: 0.7rem; font-weight: 800;
        display: flex; align-items: center; justify-content: center;
      }
      .lesson-prose code {
        background: #1e3a47; color: #6ee7b7; padding: 0.15rem 0.45rem;
        border-radius: 0.375rem; font-size: 0.9em; font-weight: 600;
      }
      .lesson-prose pre {
        background: #0f1a1f; border: 1px solid #1e3a47; border-radius: 0.75rem;
        padding: 1rem 1.25rem; margin: 1rem 0; overflow-x: auto;
      }
      .lesson-prose pre code {
        background: none; padding: 0; color: #94a3b8; font-size: 0.8rem;
        font-weight: 400;
      }
      .lesson-prose table {
        width: 100%; border-collapse: separate; border-spacing: 0;
        margin: 1rem 0; border-radius: 0.75rem; overflow: hidden;
        border: 1px solid #1e3a47;
      }
      .lesson-prose thead th {
        background: #0f1a1f; color: #6ee7b7; font-weight: 700;
        text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.08em;
        padding: 0.75rem 1rem; text-align: left; border-bottom: 2px solid #1e3a47;
      }
      .lesson-prose tbody td {
        padding: 0.65rem 1rem; border-bottom: 1px solid #162028;
        font-size: 0.9rem;
      }
      .lesson-prose tbody tr:last-child td { border-bottom: none; }
      .lesson-prose tbody tr:nth-child(even) { background: #0f1a1f40; }
      .lesson-prose tbody tr:hover { background: #1e3a4740; }
      .lesson-prose tbody td:first-child { color: #fbbf24; font-weight: 600; }
      .lesson-prose tbody td:nth-child(2) { color: #e2e8f0; }
      .lesson-prose tbody td:nth-child(3) { color: #64748b; font-size: 0.8rem; }
      .lesson-prose blockquote {
        border-left: 3px solid #34d399; background: #0f1a1f;
        padding: 0.75rem 1rem; margin: 1rem 0; border-radius: 0 0.75rem 0.75rem 0;
        color: #94a3b8;
      }
      .lesson-prose strong { color: #f8fafc; font-weight: 700; }
      .lesson-prose em { color: #a5b4fc; }
      .lesson-prose a { color: #38bdf8; text-decoration: underline; text-underline-offset: 2px; }
      .lesson-prose a:hover { color: #7dd3fc; }
      .lesson-prose hr {
        border: none; height: 2px; background: #1e3a47;
        margin: 2rem 0; border-radius: 1px;
      }

      /* ‚îÄ‚îÄ Concept widget ‚îÄ‚îÄ */
      .concept-widget {
        margin: 1.5rem 0; border-radius: 1rem; overflow: hidden;
        background: linear-gradient(135deg, #1a2d35 0%, #162028 100%);
        border: 1px solid #234; box-shadow: 0 2px 12px #0002;
      }
      .cw-header {
        display: flex; align-items: center; gap: 0.5rem;
        padding: 0.75rem 1.25rem; font-weight: 800; font-size: 0.85rem;
        color: #fbbf24; background: #0f1a1f; letter-spacing: 0.03em;
        text-transform: uppercase;
      }
      .cw-icon { font-size: 1.1rem; }
      .cw-kind {
        padding: 0.25rem 1.25rem 0; margin: 0;
        font-size: 0.8rem; color: #64748b; text-transform: capitalize;
      }
      .cw-examples { padding: 0.75rem 1.25rem 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; }
      .cw-example {
        display: inline-flex; align-items: center; gap: 0.5rem;
        background: #0f1a1f; border-radius: 0.75rem; padding: 0.5rem 0.85rem;
        border: 1px solid #1e3a47;
      }
      .cw-es { color: #fbbf24; font-weight: 700; font-size: 0.95rem; }
      .cw-arrow { color: #475569; font-size: 0.8rem; }
      .cw-en { color: #94a3b8; font-size: 0.9rem; }

      /* ‚îÄ‚îÄ Exercise widget ‚îÄ‚îÄ */
      .exercise-widget {
        margin: 1.5rem 0; border-radius: 1rem; overflow: hidden;
        background: linear-gradient(135deg, #1a2d35 0%, #162028 100%);
        border: 1px solid #234; box-shadow: 0 2px 12px #0002;
      }
      .ew-header {
        display: flex; align-items: center; gap: 0.5rem;
        padding: 0.75rem 1.25rem; font-weight: 800; font-size: 0.85rem;
        color: #34d399; background: #0f1a1f; letter-spacing: 0.03em;
        text-transform: uppercase;
      }
      .ew-icon { font-size: 1.1rem; }
      .ew-prompt {
        padding: 1rem 1.25rem 0.5rem; margin: 0;
        font-size: 1.1rem; color: #e2e8f0; font-weight: 600; line-height: 1.5;
      }

      /* MCQ options */
      .ew-options { padding: 0.5rem 1.25rem 1rem; display: grid; gap: 0.5rem; }
      .ew-opt {
        display: block; width: 100%; text-align: left;
        padding: 0.75rem 1rem; border-radius: 0.75rem;
        background: #0f1a1f; border: 2px solid #1e3a47;
        color: #cbd5e1; font-weight: 600; font-size: 0.95rem;
        cursor: pointer; transition: all 0.15s;
      }
      .ew-opt:hover:not(:disabled) {
        border-color: #34d399; color: #f8fafc; background: #162028;
      }
      .ew-opt:active:not(:disabled) { transform: scale(0.98); }
      .ew-opt-correct {
        border-color: #34d399 !important; background: #34d39920 !important;
        color: #6ee7b7 !important;
      }
      .ew-opt-wrong {
        border-color: #f87171 !important; background: #f8717120 !important;
        color: #fca5a5 !important;
      }
      .ew-opt-dim { opacity: 0.4; }
      .ew-opt:disabled { cursor: default; }

      /* Fill-in-blank */
      .ew-input-row {
        padding: 0.5rem 1.25rem 1rem; display: flex; gap: 0.5rem;
      }
      .ew-input {
        flex: 1; padding: 0.75rem 1rem; border-radius: 0.75rem;
        background: #0f1a1f; border: 2px solid #1e3a47;
        color: #f8fafc; font-size: 1rem; font-weight: 600;
        outline: none; transition: border-color 0.15s;
      }
      .ew-input:focus { border-color: #34d399; }
      .ew-input::placeholder { color: #475569; }
      .ew-input-correct { border-color: #34d399 !important; background: #34d39910 !important; }
      .ew-input-wrong { border-color: #f87171 !important; background: #f8717110 !important; }
      .ew-check {
        padding: 0.75rem 1.5rem; border-radius: 0.75rem;
        background: #34d399; color: #022c22; font-weight: 800;
        font-size: 0.9rem; border: none; cursor: pointer;
        transition: all 0.15s; white-space: nowrap;
      }
      .ew-check:hover:not(:disabled) { background: #6ee7b7; transform: scale(1.03); }
      .ew-check:active:not(:disabled) { transform: scale(0.97); }
      .ew-check:disabled, .ew-check-done {
        opacity: 0.5; cursor: default; transform: none !important;
      }

      /* Feedback */
      .ew-feedback {
        margin: 0 1.25rem 1rem; padding: 0.75rem 1rem;
        border-radius: 0.75rem; font-weight: 600; font-size: 0.9rem;
        line-height: 1.5;
      }
      .ew-fb-correct {
        background: #34d39915; border: 1px solid #34d39940;
        color: #6ee7b7;
      }
      .ew-fb-wrong {
        background: #f8717110; border: 1px solid #f8717130;
        color: #fca5a5;
      }
      .ew-fb-answer { color: #94a3b8; font-weight: 400; font-size: 0.85rem; }
      .ew-fb-answer strong { color: #e2e8f0; }

      /* ‚îÄ‚îÄ Inline practice slot ‚îÄ‚îÄ */
      .practice-slot:empty { display: none; }
      .practice-slot {
        padding: 0.75rem; animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from { opacity: 0; transform: translateY(-8px); }
        to { opacity: 1; transform: translateY(0); }
      }
      /* Auto-focus answer input when quiz loads via HTMX */
      .practice-slot input[name="answer"] { animation: focusPulse 0.6s ease-out; }
      @keyframes focusPulse {
        0% { box-shadow: 0 0 0 0 #34d39960; }
        100% { box-shadow: 0 0 0 0 transparent; }
      }
    </style>
  </head>
  <body class="bg-[#131F24] text-slate-50 min-h-screen">
    <main class="mx-auto flex min-h-screen max-w-4xl flex-col px-4 py-8 sm:px-6">
      {% if current_page is not defined or current_page != 'flow' %}
      <header class="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <a href="/" class="flex items-center gap-3 no-underline">
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-emerald-500 text-lg font-black text-emerald-950">S</span>
          <div>
            <h1 class="text-2xl font-bold tracking-tight text-slate-50">Spanish Vibes</h1>
            <p class="text-xs text-slate-400">A2 spaced-repetition trainer</p>
          </div>
        </a>
        <nav class="flex flex-wrap gap-2 text-sm font-bold">
          <a href="/" class="rounded-full px-4 py-2 transition {% if current_page is defined and current_page == 'home' %}bg-emerald-500 text-emerald-950 shadow-md shadow-emerald-500/30{% else %}bg-emerald-500/15 text-emerald-300 hover:bg-emerald-500/25 hover:text-emerald-200{% endif %}">Home</a>
          <a href="/flow" class="rounded-full px-4 py-2 transition {% if current_page is defined and current_page == 'flow' %}bg-amber-500 text-amber-950 shadow-md shadow-amber-500/30{% else %}bg-amber-500/15 text-amber-300 hover:bg-amber-500/25 hover:text-amber-200{% endif %}">Flow</a>
          {% if request.state.current_user %}
          <span class="rounded-full bg-slate-500/15 px-4 py-2 text-slate-300">{{ request.state.current_user.username }}</span>
          <form method="post" action="/auth/logout">
            <input type="hidden" name="csrf_token" value="{{ request.state.csrf_token or '' }}" />
            <button type="submit" class="rounded-full bg-slate-500/15 px-4 py-2 text-sm font-bold text-slate-300 transition hover:bg-slate-500/25 hover:text-slate-100">Logout</button>
          </form>
          {% else %}
          <a href="/auth/login" class="rounded-full bg-slate-500/15 px-4 py-2 text-slate-300 transition hover:bg-slate-500/25 hover:text-slate-100">Log In</a>
          <a href="/auth/signup" class="rounded-full bg-sky-500/15 px-4 py-2 text-sky-300 transition hover:bg-sky-500/25 hover:text-sky-200">Sign Up</a>
          {% endif %}
        </nav>
      </header>
      {% endif %}
      {% if progress is defined and progress and current_page is defined and current_page != 'flow' and current_page != 'home' %}
      <div class="mb-8 flex flex-wrap items-center gap-6 rounded-2xl bg-[#1a2d35] px-6 py-5 shadow-lg shadow-black/20">
        <!-- Level badge -->
        <div class="flex flex-col items-center gap-1">
          <span class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-emerald-500 text-xl font-black text-emerald-950 shadow-md shadow-emerald-500/30">{{ progress.level }}</span>
          <span class="text-[10px] uppercase tracking-widest text-slate-400 font-bold">Level</span>
        </div>
        <!-- XP bar -->
        <div class="flex flex-1 flex-col gap-1 min-w-[160px]">
          <div class="relative h-4 w-full overflow-hidden rounded-full bg-[#0f1a1f]">
            <div class="h-full rounded-full bg-gradient-to-r from-emerald-500 to-emerald-400 transition-all duration-500" style="width: {{ progress.level_pct }}%"></div>
            <span class="absolute inset-0 flex items-center justify-center text-[11px] font-bold text-white drop-shadow">{{ progress.xp_into_level }} / {{ progress.xp_for_next_level }} XP</span>
          </div>
        </div>
        <!-- Total XP -->
        <div class="text-center">
          <p class="text-2xl font-black text-amber-400">{{ progress.xp }}</p>
          <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">total xp</p>
        </div>
        <!-- Daily streak -->
        <div class="flex items-center gap-2">
          {% if progress.streak > 0 %}
            <span class="text-2xl">üî•</span>
            <div class="text-center">
              <p class="text-2xl font-black text-amber-400">{{ progress.streak }}</p>
              <p class="text-[10px] uppercase tracking-widest text-amber-500/70 font-bold">streak</p>
            </div>
          {% else %}
            <span class="text-2xl opacity-40">‚ùÑÔ∏è</span>
            <div class="text-center">
              <p class="text-2xl font-black text-slate-500">0</p>
              <p class="text-[10px] uppercase tracking-widest text-slate-600 font-bold">streak</p>
            </div>
          {% endif %}
        </div>
      </div>
      {% endif %}
      <section class="flex-1">
        {% block content %}
        <p class="text-slate-200">Content loading soon.</p>
        {% endblock %}
      </section>
    </main>
    <script>
      /* Auto-focus answer input and scroll quiz into view after HTMX swap */
      document.body.addEventListener('htmx:afterSwap', function(e) {
        var panel = e.detail.target;
        var input = panel.querySelector('input[name="answer"]');
        if (input && !input.disabled) {
          input.focus();
        }
        if (panel.closest('.practice-slot') || panel.id === 'quiz-panel') {
          panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });
    </script>
  </body>
</html>
