{% extends "base.html" %}
{% block title %}Spanish Vibes Â· Flow{% endblock %}
{% block content %}
<div id="flow-container" class="flex flex-col items-center gap-3">
  <!-- Compact flow header -->
  <div class="w-full flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="flex items-center gap-1" title="Streak">
        <span id="streak-fire" class="text-lg {% if streak > 0 %}{% else %}opacity-30{% endif %}">ðŸ”¥</span>
        <span id="streak-count" class="text-base font-black text-amber-400">{{ streak }}</span>
      </div>
      <span class="text-xs text-slate-500 font-bold" id="concepts-progress">{{ concepts_mastered }}/{{ total_concepts }}</span>
      <span class="hidden sm:inline rounded-full bg-amber-500/15 px-2 py-0.5 text-[10px] font-bold text-amber-300">{{ user_cefr }}</span>
    </div>
    <div class="flex items-center gap-2">
      <span class="text-xs text-slate-500" id="cards-count">{{ cards_answered }} cards</span>
      {% if show_dev %}
      <button onclick="document.getElementById('skip-modal').classList.toggle('hidden')"
        class="rounded-full bg-slate-500/15 px-2.5 py-1 text-xs font-bold text-slate-400 transition hover:bg-slate-500/25">Skip</button>
      {% endif %}
      <a href="/" class="rounded-full bg-slate-500/15 w-7 h-7 flex items-center justify-center text-xs font-bold text-slate-400 transition hover:bg-slate-500/25 hover:text-slate-200" title="Exit">&times;</a>
    </div>
  </div>

  <!-- Card slot â€” HTMX loads first card on page load -->
  <div id="flow-card-slot" class="w-full"
       data-card-type=""
       data-card-id=""
       data-concept-id=""
       data-persona-id=""
       data-conversation-type=""
       data-conversation-id=""
       hx-get="/flow/card?session_id={{ session.id }}"
       hx-trigger="load"
       hx-swap="innerHTML">
    <div class="flex items-center justify-center py-20">
      <div class="h-8 w-8 animate-spin rounded-full border-4 border-emerald-500 border-t-transparent"></div>
    </div>
  </div>

  {% if show_dev %}
  <!-- Skip level modal (dev only) -->
  <div id="skip-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/60 backdrop-blur-sm">
    <div class="rounded-2xl bg-[#1a2d35] p-6 shadow-xl ring-1 ring-sky-500/20 w-80">
      <h3 class="text-lg font-black text-slate-50 mb-2">Skip to Level</h3>
      <p class="text-sm text-slate-400 mb-4">Mark all concepts below this tier as mastered.</p>
      <form method="post" action="/flow/skip-to-tier" class="flex flex-col gap-3">
        <button type="submit" name="tier" value="2" class="w-full rounded-xl bg-[#0f1a1f] px-4 py-3 text-left text-sm font-medium text-slate-200 hover:ring-1 hover:ring-sky-500/30 transition">
          <span class="font-bold text-sky-300">Tier 2</span> â€” Skip greetings, numbers, colors
        </button>
        <button type="submit" name="tier" value="3" class="w-full rounded-xl bg-[#0f1a1f] px-4 py-3 text-left text-sm font-medium text-slate-200 hover:ring-1 hover:ring-sky-500/30 transition">
          <span class="font-bold text-sky-300">Tier 3</span> â€” Skip pronouns, gender, basic vocab
        </button>
        <button type="submit" name="tier" value="4" class="w-full rounded-xl bg-[#0f1a1f] px-4 py-3 text-left text-sm font-medium text-slate-200 hover:ring-1 hover:ring-sky-500/30 transition">
          <span class="font-bold text-sky-300">Tier 4</span> â€” Skip articles, ser/tener/hay
        </button>
        <button type="submit" name="tier" value="5" class="w-full rounded-xl bg-[#0f1a1f] px-4 py-3 text-left text-sm font-medium text-slate-200 hover:ring-1 hover:ring-sky-500/30 transition">
          <span class="font-bold text-sky-300">Tier 5</span> â€” Skip estar, ir a, gustar, adjectives
        </button>
        <button type="button" onclick="document.getElementById('skip-modal').classList.add('hidden')"
          class="w-full rounded-xl bg-slate-700 px-4 py-2.5 text-sm font-bold text-slate-300 hover:bg-slate-600 transition">
          Cancel
        </button>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- Celebration overlay (hidden by default) -->
  <div id="celebration-overlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm">
    <div class="text-center animate-bounce">
      <p class="text-6xl">ðŸ”¥</p>
      <p id="celebration-text" class="mt-4 text-3xl font-black text-amber-400"></p>
    </div>
  </div>

  {% if show_dev %}
  {% include "partials/dev_panel.html" %}
  {% endif %}
</div>

<style>
  @media (min-width: 1280px) {
    #flow-container {
      max-width: 42rem;
      margin-left: auto;
      margin-right: auto;
    }
    {% if show_dev %}
    main:has(#flow-container) {
      max-width: none;
      padding-left: 19rem;
      padding-right: 19rem;
    }
    {% endif %}
  }

  /* â”€â”€ Card transitions â”€â”€ */
  #flow-card-slot {
    transition: opacity 0.15s ease-out;
  }
  #flow-card-slot.htmx-swapping {
    opacity: 0;
    transform: scale(0.98);
    transition: opacity 0.1s ease-in, transform 0.1s ease-in;
  }

  @keyframes cardIn {
    from { opacity: 0; transform: translateY(12px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  .flow-card-enter { animation: cardIn 0.25s ease-out; }

  @keyframes correctPop {
    0% { transform: scale(0.97); opacity: 0.8; }
    50% { transform: scale(1.01); }
    100% { transform: scale(1); opacity: 1; }
  }
  .correct-flash { animation: correctPop 0.35s ease-out; }

  @keyframes wrongShake {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-4px); }
    40% { transform: translateX(4px); }
    60% { transform: translateX(-3px); }
    80% { transform: translateX(2px); }
  }
  .wrong-flash { animation: wrongShake 0.35s ease-out; }

  /* â”€â”€ Streak pop â”€â”€ */
  @keyframes streakPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }
  .streak-pop { animation: streakPop 0.3s ease-out; }

  /* â”€â”€ XP badge slide â”€â”€ */
  @keyframes xpSlide {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .xp-badge { animation: xpSlide 0.3s ease-out 0.1s both; }

  /* â”€â”€ Mobile: less padding, tighter spacing â”€â”€ */
  @media (max-width: 640px) {
    main { padding-left: 0.75rem !important; padding-right: 0.75rem !important; padding-top: 1rem !important; }
    #flow-container { gap: 0.5rem; }
  }
</style>

<script>
  // â”€â”€ Speech utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (function() {
    function hideUnsupportedFeatures(root) {
      var scope = root || document;
      if (!window.speechSynthesis) {
        scope.querySelectorAll('[title="Listen"], [title="Listen to pronunciation"], [title="Listen to example"]').forEach(function(btn) {
          btn.style.display = 'none';
        });
      }
      if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
        scope.querySelectorAll('#conv-mic-btn, [title="Speak in Spanish"]').forEach(function(btn) {
          btn.style.display = 'none';
        });
      }
    }

    window.speakSpanish = function(text, rate) {
      if (!window.speechSynthesis || !text) return;
      speechSynthesis.cancel();

      var utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'es-ES';
      utterance.rate = rate || 0.85;
      utterance.pitch = 1;

      var voices = speechSynthesis.getVoices();
      var spanishVoice = voices.find(function(v) { return v.lang && v.lang.startsWith('es'); });
      if (spanishVoice) {
        utterance.voice = spanishVoice;
      }

      utterance.onstart = function() {
        var btn = document.querySelector('.speak-active');
        if (btn) btn.classList.add('animate-pulse');
      };
      utterance.onend = function() {
        var btn = document.querySelector('.speak-active');
        if (btn) btn.classList.remove('animate-pulse', 'speak-active');
      };

      speechSynthesis.speak(utterance);
    };

    if (window.speechSynthesis) {
      speechSynthesis.getVoices();
      speechSynthesis.onvoiceschanged = function() {
        speechSynthesis.getVoices();
      };
    }

    window.startSpanishListening = function(inputSelector, statusSelector, micBtnSelector) {
      var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert('Speech recognition is not supported in your browser. Please use Chrome or Edge.');
        return;
      }

      var recognition = new SpeechRecognition();
      recognition.lang = 'es-ES';
      recognition.continuous = false;
      recognition.interimResults = true;
      recognition.maxAlternatives = 1;

      var input = document.querySelector(inputSelector);
      var status = document.querySelector(statusSelector);
      var micBtn = document.querySelector(micBtnSelector);

      if (micBtn) {
        micBtn.classList.add('text-red-400', 'animate-pulse');
        micBtn.disabled = true;
      }
      if (status) {
        status.textContent = 'Escuchando...';
        status.classList.remove('hidden');
      }

      recognition.onresult = function(event) {
        var transcript = '';
        for (var i = event.resultIndex; i < event.results.length; i++) {
          transcript = event.results[i][0].transcript;
        }
        if (input) input.value = transcript;
      };

      recognition.onerror = function(event) {
        console.warn('Speech recognition error:', event.error);
        if (status) {
          if (event.error === 'no-speech') {
            status.textContent = 'No speech detected. Try again.';
          } else if (event.error === 'not-allowed') {
            status.textContent = 'Microphone access denied.';
          } else {
            status.textContent = 'Error: ' + event.error;
          }
        }
      };

      recognition.onend = function() {
        if (micBtn) {
          micBtn.classList.remove('text-red-400', 'animate-pulse');
          micBtn.disabled = false;
        }
        if (status) {
          setTimeout(function() { status.classList.add('hidden'); }, 2000);
        }
      };

      recognition.start();
    };

    document.addEventListener('DOMContentLoaded', function() {
      hideUnsupportedFeatures(document);
    });

    document.body.addEventListener('htmx:afterSwap', function(e) {
      hideUnsupportedFeatures(e.detail.target || document);
    });
  })();

  window.flowStartTime = 0;

  document.body.addEventListener('htmx:afterSwap', function(e) {
    if (e.detail.target.id === 'flow-card-slot' || e.detail.target.closest('#flow-card-slot')) {
      window.flowStartTime = Date.now();
      var timeInput = document.querySelector('#flow-card-slot input[name="start_time"]');
      if (timeInput) {
        timeInput.value = window.flowStartTime;
      }
      var meta = document.querySelector('#flow-card-slot [data-dev-card-type]');
      var slot = document.getElementById('flow-card-slot');
      if (meta && slot) {
        slot.dataset.cardType = meta.dataset.devCardType || '';
        slot.dataset.cardId = meta.dataset.devCardId || '';
        slot.dataset.conceptId = meta.dataset.devConceptId || '';
        slot.dataset.personaId = meta.dataset.devPersonaId || '';
        slot.dataset.conversationType = meta.dataset.devConversationType || '';
        slot.dataset.conversationId = meta.dataset.devConversationId || '';
      }
      document.body.dispatchEvent(new CustomEvent('cardChanged'));
    }
  });

  function showCelebration(streak) {
    var milestones = [5, 10, 15, 20, 25, 50];
    if (milestones.indexOf(streak) === -1) return;
    var overlay = document.getElementById('celebration-overlay');
    var text = document.getElementById('celebration-text');
    text.textContent = streak + ' streak!';
    overlay.classList.remove('hidden');
    overlay.classList.add('flex');
    setTimeout(function() {
      overlay.classList.add('hidden');
      overlay.classList.remove('flex');
    }, 1500);
  }
</script>
{% endblock %}
